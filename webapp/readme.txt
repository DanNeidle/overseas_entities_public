==============================================================================
OVERSEAS ENTITIES MAP - ARCHITECTURE & DATA FLOW DOCUMENTATION
==============================================================================

Project: Overseas Entities Map
Version: 0.95 (Binary + Caching Optimized)
Copyright: Â© Tax Policy Associates Ltd 2026
License: Creative Commons BY-SA 4.0

==============================================================================
1. OVERVIEW
==============================================================================
This is a client-side visualization tool mapping tens of thousands of UK
properties owned by overseas entities. To ensure performance on mobile devices
and slow connections, the application uses a data loading pipeline involving
binary transport (MessagePack), client-side caching (IndexedDB via LocalForage),
and lightweight schema expansion on the client.

There is no dynamic backend. The app consumes static files generated by a
Python export script.

==============================================================================
2. CRITICAL DATA FLOW (THE LOADING PIPELINE)
==============================================================================
Entry point is App.init() in app.js, which calls initializeDataLoad() in
startup.js. Data loading is handled by DataService.loadAll() in data-service.js.

Step 1: Control Types
---------------------
The app first loads overseas_entities_map_control_types.json to map control
codes to icons and descriptions used in the info panel.

Step 2: Manifest Fetch
----------------------
The app fetches overseas_entities_data_info.txt. Expected lines:
1) Total uncompressed size (bytes) for the progress bar.
2) An 8-char data hash (used for cache validation and optional file naming).
3) A display label (e.g., "January 2026 data").

If a valid hash is present, the app will prefer hashed filenames like:
  overseas_entities_properties.<HASH>.msgpack
  overseas_entities_proprietors.<HASH>.msgpack
Otherwise it falls back to the default filenames.

Step 3: Cache Check (Version Control)
-------------------------------------
LocalForage (IndexedDB) is used when available, keyed by CONFIG.CACHE.*:
- oe-data-version-v2
- oe-properties-v2
- oe-proprietors-v2

[PATH A: CACHE HIT] (Fast)
If the cached hash matches the manifest hash:
1. Load properties (flat array) and proprietors (dictionary) from IndexedDB.
2. HYDRATION: resolveProprietorRefs() links property pids to proprietor objects.
3. RENDER: buildPropertyMarkers() and buildOwnerMarkers().

[PATH B: CACHE MISS / UPDATE] (Slow)
If the hash differs or data is missing:
1. Download properties msgpack.
2. Download proprietors msgpack.
3. DECODE: MessagePack.decode() to JS objects.
4. EXPAND: expandSchema() / expandProprietorsDictShortToLong().
5. PERSIST: Save the expanded, unlinked data to IndexedDB immediately.
6. HYDRATION: resolveProprietorRefs() to link objects in memory.
7. RENDER: Build map markers.

If the proprietors load fails, the app can still start in a partial mode
(properties only).

==============================================================================
3. DATA STRUCTURES
==============================================================================

A. Short Schema (Network Format)
--------------------------------
To save bandwidth, keys are minified in the MessagePack files:
- Property: { t: "Title", lat: 0.0, lon: 0.0, ps: [1, 4] ... }
- Proprietor: { n: "Name", a: "Address", ... }

B. Long Schema (Runtime Format)
-------------------------------
Expanded at runtime for readability:
- Property: { property_title_number: "...", pids: [1, 4], props: [Obj, Obj] }

C. The Reference Trap Logic
---------------------------
Properties relate to Proprietors via a many-to-many relationship.
- On the network/disk: properties store an array of integers (pids).
- In memory: properties store an array of object references (props).

==============================================================================
4. CLIENT FILES (WHAT EACH DOES)
==============================================================================
- config.js: Central configuration (map options, URLs, cache keys, icons).
- app.js: App entry point, global state, controller init, start data load.
- startup.js: Startup orchestration, URL state restore, defaults, reset logic.
- data-service.js: Manifest parsing, msgpack loading, schema expansion,
  LocalForage cache, and reference hydration.
- map-service.js: Leaflet map setup, marker cluster layers, marker building,
  mode switching, and link drawing.
- map-utils.js: Shared map helpers (chunked processing, permalink helpers).
- searching.js: Place search helpers and map-fly behavior.
- controller.js: Event bindings (legend, search, share, map UI actions).
- ui.js: UI rendering and helpers (panels, lists, focus mode, filters).
- info-panel.js: Info panel markup, tooltips, history, highlight ring, export.
- utils.js: General helpers (formatting, lookup, normalization).
- tutorial.js: Intro.js tutorial flow and helper overlays.
- overseas_entities_map.css: App styling.

==============================================================================
5. KEY LIBRARIES
==============================================================================
1. Leaflet + Leaflet.markercluster: Map rendering and clustering.
2. MessagePack (@msgpack/msgpack): High-performance binary deserialization.
3. LocalForage: IndexedDB wrapper for cached datasets.
4. LZ-String: URL compression for the share-state feature.
5. jQuery: AJAX helpers and small utilities.

==============================================================================
6. FILE MANIFEST (SERVER SIDE)
==============================================================================
The web server must host the following static files generated by the exporter:

- index.html
- overseas_entities_map.css
- config.js
- app.js, startup.js, data-service.js, map-service.js, map-utils.js,
  searching.js, controller.js, ui.js, info-panel.js, utils.js, tutorial.js
- overseas_entities_map_control_types.json
- overseas_entities_data_info.txt
- overseas_entities_properties.msgpack (or hashed variant)
- overseas_entities_proprietors.msgpack (or hashed variant)

==============================================================================
7. DEVELOPER NOTES
==============================================================================
- Debugging: Set CONFIG.DEBUG.LIMIT in config.js to load a smaller subset.
- Clearing cache: Delete IndexedDB for the site or change the manifest hash.
- Memory: The app holds many objects in memory. Avoid attaching large DOM
  structures to each marker or creating circular references.
